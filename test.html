<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LolTroll</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-theme-bg-color: #212121; --tg-theme-text-color: #ffffff;
            --tg-theme-hint-color: #aaaaaa; --tg-theme-link-color: #8774e1;
            --tg-theme-button-color: #8774e1; --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #181818;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); margin: 0; padding: 15px; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s ease; }
        .page-title { font-size: 28px; font-weight: 700; text-align: center; margin-bottom: 30px; }
        .main-menu-btn { display: block; width: 100%; padding: 15px; margin-bottom: 15px; border-radius: 12px; border: none; background-color: var(--tg-theme-secondary-bg-color); color: var(--tg-theme-text-color); font-size: 18px; font-weight: 600; text-align: left; cursor: pointer; transition: transform 0.2s ease; }
        .main-menu-btn:active { transform: scale(0.98); }
        .btn-back { display: inline-block; margin-bottom: 20px; font-size: 16px; color: var(--tg-theme-link-color); cursor: pointer; }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: var(--tg-theme-hint-color); }
        input, select, textarea { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--tg-theme-secondary-bg-color); background-color: var(--tg-theme-secondary-bg-color); color: var(--tg-theme-text-color); font-size: 16px; box-sizing: border-box; }
        textarea { resize: vertical; min-height: 100px;}
        .btn-primary { width: 100%; padding: 15px; border: none; border-radius: 12px; background-color: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color); font-size: 18px; font-weight: 600; cursor: pointer; }
        .user-list { max-height: 200px; overflow-y: auto; border: 1px solid var(--tg-theme-secondary-bg-color); border-radius: 8px; margin-top: 5px; }
        .list-item { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid var(--tg-theme-secondary-bg-color); }
        .list-item:last-child { border-bottom: none; }
        .list-item:hover { background-color: #313131; }
        .list-item.selected { background-color: var(--tg-theme-link-color); }
        .template-card { background-color: var(--tg-theme-secondary-bg-color); padding: 15px; border-radius: 12px; margin-bottom: 10px; }
        .template-card-header { display: flex; justify-content: space-between; align-items: center; }
        .template-name { font-size: 18px; font-weight: 600; }
        .template-text { word-break: break-word; color: var(--tg-theme-hint-color); margin: 10px 0; }
        .btn-delete { background: none; border: none; color: #ff4d4d; cursor: pointer; }
        .btn-add { background: none; border: none; color: #40a852; cursor: pointer; }
        .faq-text a { color: var(--tg-theme-link-color); text-decoration: none;}
        #loader { text-align: center; margin-top: 50px; font-size: 18px; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="loader"><p>–ó–∞–≥—Ä—É–∑–∫–∞...</p></div>

    <div id="main-menu" class="page">
        <h1 class="page-title">LolTroll</h1>
        <button class="main-menu-btn" onclick="showPage('attack-page')">üí• –ù–∞—á–∞—Ç—å –∞—Ç–∞–∫—É</button>
        <button class="main-menu-btn" onclick="showPage('templates-page')">üìÇ –®–∞–±–ª–æ–Ω—ã</button>
        <button class="main-menu-btn" onclick="showPage('faq-page')">‚ùì FAQ</button>
    </div>

    <div id="attack-page" class="page">
        <p class="btn-back" onclick="showPage('main-menu')">‚Üê –ù–∞–∑–∞–¥</p>
        <h1 class="page-title">–ù–∞—á–∞—Ç—å –∞—Ç–∞–∫—É</h1>
        <div class="input-group"><label for="user-search">–ü–æ–∏—Å–∫ –∏–ª–∏ ID/@username</label><input type="text" id="user-search" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –¥–ª—è –ø–æ–∏—Å–∫–∞..."></div>
        <div class="input-group"><label>–í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª—å</label><div id="user-list" class="user-list"></div></div>
        <div class="input-group"><label for="template-select">–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω</label><select id="template-select"></select></div>
        <div class="input-group"><label for="delay-input">–ó–∞–¥–µ—Ä–∂–∫–∞ (0.1 - 2.0 —Å–µ–∫)</label><input type="number" id="delay-input" value="0.3" step="0.1" min="0.1" max="2.0"></div>
        <button id="start-attack-btn" class="btn-primary">–°—Ç–∞—Ä—Ç!</button>
    </div>

    <div id="templates-page" class="page">
        <p class="btn-back" onclick="showPage('main-menu')">‚Üê –ù–∞–∑–∞–¥</p>
        <h1 class="page-title">–®–∞–±–ª–æ–Ω—ã</h1>
        <button class="main-menu-btn" onclick="showPage('my-templates-page')">üìÑ –ú–æ–∏ —à–∞–±–ª–æ–Ω—ã</button>
        <button class="main-menu-btn" onclick="showPage('market-templates-page')">üõí –ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å</button>
    </div>

    <div id="my-templates-page" class="page">
        <p class="btn-back" onclick="showPage('templates-page')">‚Üê –ù–∞–∑–∞–¥</p>
        <h1 class="page-title">–ú–æ–∏ —à–∞–±–ª–æ–Ω—ã</h1>
        <div id="my-templates-list"></div>
        <button class="btn-primary" onclick="showPage('create-template-page')">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π</button>
    </div>

    <div id="create-template-page" class="page">
        <p class="btn-back" onclick="showPage('my-templates-page')">‚Üê –û—Ç–º–µ–Ω–∞</p>
        <h1 class="page-title">–ù–æ–≤—ã–π —à–∞–±–ª–æ–Ω</h1>
        <div class="input-group"><label for="template-name-input">–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="template-name-input"></div>
        <div class="input-group"><label for="template-text-input">–¢–µ–∫—Å—Ç (—Å–ª–æ–≤–∞ —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª)</label><textarea id="template-text-input"></textarea></div>
        <button id="save-template-btn" class="btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>

    <div id="market-templates-page" class="page">
        <p class="btn-back" onclick="showPage('templates-page')">‚Üê –ù–∞–∑–∞–¥</p>
        <h1 class="page-title">–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å</h1>
        <div id="market-templates-list"></div>
    </div>

    <div id="faq-page" class="page">
        <p class="btn-back" onclick="showPage('main-menu')">‚Üê –ù–∞–∑–∞–¥</p>
        <h1 class="page-title">FAQ?</h1>
        <div class="faq-text"><p><strong>LolTroll</strong> - —Å–µ—Ä–≤–∏—Å –¥–ª—è —Ç—Ä–æ–ª–ª–∏–Ω–≥–∞.</p><p>–°–æ–∑–¥–∞—Ç–µ–ª—å - <a href="https://t.me/nepravel" target="_blank">nepravel</a></p></div>
    </div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    let allUsers = [], selectedUserId = null;

    const api = {
        async request(url, options = {}) {
            const response = await fetch(url, options);
            if (!response.ok) {
                const error = await response.json();
                tg.showAlert(`–û—à–∏–±–∫–∞: ${error.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
                throw new Error(error.detail);
            }
            return response.json();
        },
        get(url) { return this.request(url); },
        post(url, data) { return this.request(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }); },
        delete(url) { return this.request(url, { method: 'DELETE' }); }
    };

    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        if (pageId === 'attack-page') loadAttackPage();
        else if (pageId === 'my-templates-page') loadMyTemplates();
        else if (pageId === 'market-templates-page') loadMarketTemplates();
    }

    async function loadAttackPage() {
        try {
            [allUsers, templates] = await Promise.all([api.get('/api/dialogs'), api.get('/api/templates/my')]);
            renderUserList(allUsers);
            document.getElementById('template-select').innerHTML = Object.keys(templates).map(name => `<option value="${name}">${name}</option>`).join('');
        } catch (e) { document.getElementById('user-list').innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.</p>'; }
    }

    async function loadMyTemplates() {
        const listDiv = document.getElementById('my-templates-list');
        listDiv.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
        const templates = await api.get('/api/templates/my');
        const names = Object.keys(templates);
        if (names.length === 0) { listDiv.innerHTML = '<p>–£ –≤–∞—Å –Ω–µ—Ç —à–∞–±–ª–æ–Ω–æ–≤.</p>'; return; }
        listDiv.innerHTML = names.map(name => `
            <div class="template-card">
                <div class="template-card-header">
                    <div class="template-name">${name}</div>
                    <button class="btn-delete" onclick="deleteTemplate('${name}')">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
                <div class="template-text">${templates[name]}</div>
            </div>`).join('');
    }

    async function loadMarketTemplates() {
        const listDiv = document.getElementById('market-templates-list');
        listDiv.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
        const templates = await api.get('/api/templates/market');
        const names = Object.keys(templates);
        if (names.length === 0) { listDiv.innerHTML = '<p>–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å –ø—É—Å—Ç.</p>'; return; }
        listDiv.innerHTML = names.map(name => `
            <div class="template-card">
                <div class="template-card-header">
                    <div class="template-name">${name}</div>
                    <button class="btn-add" onclick="addFromMarket('${name}')">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
                <p style="font-size: 14px; color: var(--tg-theme-hint-color);">–ê–≤—Ç–æ—Ä: ${templates[name].author}</p>
                <div class="template-text">${templates[name].text}</div>
            </div>`).join('');
    }

    function renderUserList(users) {
        const listDiv = document.getElementById('user-list');
        listDiv.innerHTML = users.length === 0 ? '<p>–ù–µ –Ω–∞–π–¥–µ–Ω–æ.</p>' : users.map(user => `
            <div class="list-item" data-user-id="${user.id}" data-user-name="${user.name} (${user.username})">
                <div>${user.name}</div><div style="font-size: 14px; color: var(--tg-theme-hint-color);">${user.username}</div>
            </div>`).join('');
        document.querySelectorAll('.list-item').forEach(item => item.addEventListener('click', () => {
            document.querySelectorAll('.list-item').forEach(i => i.classList.remove('selected'));
            item.classList.add('selected');
            selectedUserId = item.dataset.userId;
            document.getElementById('user-search').value = item.dataset.userName;
        }));
    }

    document.getElementById('user-search').addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        selectedUserId = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –ø—Ä–∏ —Ä—É—á–Ω–æ–º –≤–≤–æ–¥–µ
        renderUserList(allUsers.filter(u => u.name.toLowerCase().includes(term) || u.username.toLowerCase().includes(term)));
    });

    document.getElementById('start-attack-btn').addEventListener('click', async () => {
        const target = selectedUserId || document.getElementById('user-search').value;
        const templateName = document.getElementById('template-select').value;
        const delay = parseFloat(document.getElementById('delay-input').value);
        if (!target || !templateName) { tg.showAlert('–í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª—å –∏ —à–∞–±–ª–æ–Ω.'); return; }
        tg.showPopup({ title: '–ê—Ç–∞–∫–∞!', message: `–ó–∞–ø—É—Å–∫–∞—é –∞—Ç–∞–∫—É –Ω–∞ ${target}...`, buttons: [{type: 'ok'}]});
        await api.post('/api/attack', { target_id: target, template_name: templateName, delay });
        showPage('main-menu');
    });

    document.getElementById('save-template-btn').addEventListener('click', async () => {
        const name = document.getElementById('template-name-input').value.trim();
        const text = document.getElementById('template-text-input').value.trim();
        if (!name || !text) { tg.showAlert('–ù–∞–∑–≤–∞–Ω–∏–µ –∏ —Ç–µ–∫—Å—Ç –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º–∏.'); return; }
        await api.post('/api/templates/my', { name, text });
        tg.showAlert('–®–∞–±–ª–æ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
        document.getElementById('template-name-input').value = '';
        document.getElementById('template-text-input').value = '';
        showPage('my-templates-page');
    });

    async function deleteTemplate(name) {
        tg.showConfirm(`–£–¥–∞–ª–∏—Ç—å —à–∞–±–ª–æ–Ω "${name}"?`, async (ok) => {
            if (ok) { await api.delete(`/api/templates/my/${name}`); tg.showAlert('–®–∞–±–ª–æ–Ω —É–¥–∞–ª–µ–Ω.'); loadMyTemplates(); }
        });
    }

    async function addFromMarket(name) {
        await api.post('/api/templates/market/add', { name });
        tg.showAlert(`–®–∞–±–ª–æ–Ω "${name}" –¥–æ–±–∞–≤–ª–µ–Ω.`);
    }

    window.addEventListener('load', async () => {
        try {
            await api.get('/api/status');
            document.getElementById('loader').style.display = 'none';
            showPage('main-menu');
        } catch (e) {
            document.getElementById('loader').innerHTML = '<p>–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±—ç–∫–µ–Ω–¥ –∏ –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç.</p>';
        }
    });
</script>
</body>
</html>
